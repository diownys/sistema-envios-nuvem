<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Venda</title>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f9; margin: 0; padding: 2rem; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: 1 / -1; }
        label { font-weight: bold; margin-bottom: 0.5rem; }
        input, select { padding: 0.8rem; border-radius: 5px; border: 1px solid #ccc; font-size: 1rem; }
        input:read-only { background-color: #e9ecef; cursor: not-allowed;}
        .form-actions { margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem; }
        .btn { padding: 0.8rem 1.5rem; text-decoration: none; border-radius: 5px; color: white; border: none; cursor: pointer; font-size: 1rem; }
        .btn-save { background-color: #28a745; }
        .btn-cancel { background-color: #6c757d; }
        .message { font-weight: bold; margin-top: 1rem; padding: 0.5rem; border-radius: 4px; }
        .message.success { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb;}
        .message.error { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb;}
        .message.info { color: #0c5460; background-color: #d1ecf1; border: 1px solid #bee5eb;}
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 20px; height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block; margin-left: 10px; vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Pequeno spinner para o campo UF */
        .uf-loader {
            border: 2px solid #f3f3f3; border-top: 2px solid #3498db;
            border-radius: 50%; width: 12px; height: 12px;
            animation: spin 1s linear infinite;
            display: none; /* Começa escondido */
            margin-left: 5px; vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="page-title">Carregando Formulário...</h1>
        <div id="lookup-status" class="message" style="display: none;"></div>

        <form id="envio-form">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label for="marca">Marca</label>
                    <select id="marca" name="marca" required>
                        <option value="Neuvye">Neuvye</option>
                        <option value="DrogaVET">DrogaVET</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="codigo_venda">Código da Venda (PharmUp)</label>
                    <input type="text" id="codigo_venda" name="codigo_venda" required>
                    <button type="button" id="buscar-pharmup-btn" class="btn" style="margin-top: 5px; width: auto; background-color: #007bff;">Buscar Dados PharmUp</button>
                 </div>
                <div class="form-group"><label for="ordem_manipulacao">Ordem de Manipulação</label><input type="text" id="ordem_manipulacao" name="ordem_manipulacao"></div>
                <div class="form-group full-width"><label for="cliente_nome">Nome do Cliente</label><input type="text" id="cliente_nome" name="cliente_nome" required></div>
                <div class="form-group"><label for="valor_venda">Valor da Venda (R$)</label><input type="text" id="valor_venda" name="valor_venda" required></div>
                <div class="form-group"><label for="volumes">Volumes</label><input type="number" id="volumes" name="volumes" value="1" required></div>

                <div class="form-group"><label for="janela_coleta">Janela/Local de Coleta</label><input type="text" id="janela_coleta" name="janela_coleta" required></div>

                <div class="form-group full-width"><label for="endereco">Endereço (Rua, Nº - Compl., Bairro, CEP)</label><input type="text" id="endereco" name="endereco"></div>
                <div class="form-group"><label for="cidade">Cidade</label><input type="text" id="cidade" name="cidade"></div>
                <div class="form-group">
                     <label for="uf">UF</label>
                     <div> <input type="text" id="uf" name="uf" maxlength="2" style="width: 80px; display: inline-block;">
                       <div id="uf-loader" class="loader uf-loader"></div> </div>
                 </div>
            </div>
            <div class="form-actions">
                <a href="/index.html" id="cancel-link" class="btn btn-cancel">Cancelar</a>
                <button type="submit" class="btn btn-save">Salvar</button>
            </div>
        </form>
        <div id="success-message" class="message success" style="display: none;"></div>
    </div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const SUPABASE_URL = 'https://nfsuisftzddegihyhoha.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mc3Vpc2Z0emRkZWdpaHlob2hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMTcwMDcsImV4cCI6MjA3NDU5MzAwN30.tM_9JQo6ejzOBWKQ9XxT54f8NuM6jSoHomF9c_IfEJI';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const form = document.getElementById('envio-form');
    const pageTitle = document.getElementById('page-title');
    const successMessage = document.getElementById('success-message');
    const lookupStatus = document.getElementById('lookup-status');
    const codigoVendaInput = document.getElementById('codigo_venda');
    const buscarPharmUpBtn = document.getElementById('buscar-pharmup-btn');
    const ufLoader = document.getElementById('uf-loader'); // Spinner da UF

    // Mapeamento dos campos JSON para IDs do formulário
    const fieldMapping = {
        'Cliente.Nome': 'cliente_nome',
        'ValorFinal': 'valor_venda',
        'LocalEntrega.Descricao': 'janela_coleta',
        'EnderecoEntrega.Cidade': 'cidade',
        // 'EnderecoEntrega.UF': 'uf', // UF será preenchida pela busca de CEP
        // Campos especiais:
        'ordem_manipulacao': 'ordem_manipulacao',
        'endereco': 'endereco',
        'marca': 'marca'
    };

    // Lista de IDs dos campos afetados pela busca automática
    // (não necessariamente todos serão preenchidos, mas podem ser limpados ou ter estado alterado)
    const autoAffectedFields = ['ordem_manipulacao', 'cliente_nome', 'valor_venda', 'janela_coleta', 'endereco', 'cidade', 'uf'];


    let editMode = false;
    let envioId = null;
    let originalJanela = '';

    document.addEventListener('DOMContentLoaded', async () => {
        // ... (lógica de autenticação e verificação de modo edição/adição - sem mudanças) ...
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) { window.location.href = '/login.html'; return; }

        const params = new URLSearchParams(window.location.search);
        envioId = params.get('id');

        if (envioId) {
            editMode = true;
            pageTitle.textContent = 'Editar Venda';
            codigoVendaInput.readOnly = true;
            buscarPharmUpBtn.style.display = 'none';
            lookupStatus.style.display = 'none';
            await fetchAndPopulateForm(envioId);
        } else {
            editMode = false;
            pageTitle.textContent = 'Adicionar Nova Venda';
            document.getElementById('cancel-link').href = '/index.html';
            buscarPharmUpBtn.addEventListener('click', handlePharmUpLookup);
            // Garante que campos com readonly no HTML não fiquem assim na adição
            autoAffectedFields.forEach(id => {
               const element = document.getElementById(id);
               if(element) element.readOnly = false;
            });
        }
    });

    // Função para carregar dados na EDIÇÃO (marca campos como readonly)
    async function fetchAndPopulateForm(id) {
        try {
            const { data, error } = await supabase.functions.invoke('get-envio-by-id', { body: { id: parseInt(id) } });
            if (error) throw error;
            const envio = data.envio;
            let fieldsToMakeReadOnly = []; // Guarda os campos que foram preenchidos

            for (const key in envio) {
                const input = document.getElementById(key);
                if (input) {
                    input.value = envio[key];
                     // Marca campos como readonly QUANDO CARREGADOS DO BANCO (EDIÇÃO)
                     if (autoAffectedFields.includes(key) || key === 'codigo_venda') {
                        // Não marca volumes como readonly
                        if (key !== 'volumes') {
                             input.readOnly = true;
                             fieldsToMakeReadOnly.push(key); // Adiciona à lista
                        }
                    }
                }
            }
             const marcaSelect = document.getElementById('marca');
             if (marcaSelect && envio.marca) {
                 marcaSelect.value = envio.marca;
                 // marcaSelect.disabled = true; // Desabilitar select na edição?
             }

            pageTitle.textContent = `Editar Venda #${envio.codigo_venda}`;
            originalJanela = envio.janela_coleta;
            document.getElementById('cancel-link').href = `vendas.html?janela=${encodeURIComponent(originalJanela)}`;

             // Guarda a lista de campos que foram marcados como readonly
             form.dataset.readonlyFields = JSON.stringify(fieldsToMakeReadOnly);

        } catch (error) {
            alert(`Erro ao carregar dados da venda: ${error.message}`);
        }
    }


    // Função que lida com a busca no PharmUp
    async function handlePharmUpLookup() {
        // ... (lógica inicial de pegar código, mostrar status, desabilitar - sem mudanças) ...
        const codigo = codigoVendaInput.value.trim();
        if (!codigo) {
            clearAutoFilledFields();
            lookupStatus.style.display = 'none';
            return;
        }

        lookupStatus.innerHTML = 'Buscando dados no PharmUp... <div class="loader"></div>';
        lookupStatus.className = 'message info';
        lookupStatus.style.display = 'block';
        disableFormFieldsDuringLookup(true);

        try {
            const { data, error } = await supabase.functions.invoke('buscador-vendas', {
                body: { codigoVenda: codigo }
            });

            if (error) {
                 if (error.context && error.context.status === 404) {
                     throw new Error(error.context.json.error || "Venda não encontrada no PharmUp.");
                 } else {
                    throw new Error(error.context?.json?.error || error.message || "Erro desconhecido ao buscar dados.");
                 }
            }

            // MUDANÇA: Torna populateFormWithPharmUpData async para esperar a busca de CEP
            await populateFormWithPharmUpData(data);
            lookupStatus.textContent = 'Dados carregados do PharmUp! Verifique e edite se necessário.';
            lookupStatus.className = 'message success';

        } catch (err) {
            console.error('Erro na busca PharmUp:', err);
            lookupStatus.textContent = `Erro: ${err.message}`;
            lookupStatus.className = 'message error';
            clearAutoFilledFields();

        } finally {
            disableFormFieldsDuringLookup(false); // Reabilita campos (editáveis)
        }
    }

    // --- NOVA FUNÇÃO: Busca UF pelo CEP usando ViaCEP ---
    async function fetchUfFromCep(cep) {
        if (!cep) return null; // Retorna null se não houver CEP
        const cleanCep = cep.replace(/\D/g, ''); // Remove traços, pontos, etc.
        if (cleanCep.length !== 8) {
            console.warn("CEP inválido para busca de UF:", cep);
            return null; // CEP inválido
        }

        const ufInput = document.getElementById('uf');
        ufLoader.style.display = 'inline-block'; // Mostra spinner da UF
        if (ufInput) ufInput.disabled = true; // Desabilita campo UF durante busca

        try {
            const response = await fetch(`https://viacep.com.br/ws/${cleanCep}/json/`);
            if (!response.ok) {
                throw new Error(`ViaCEP respondeu com status ${response.status}`);
            }
            const data = await response.json();
            if (data.erro) {
                throw new Error(`CEP ${cep} não encontrado pelo ViaCEP.`);
            }
            return data.uf || null; // Retorna a UF ou null se não encontrar
        } catch (error) {
            console.error("Erro ao buscar UF pelo CEP:", error.message);
            lookupStatus.textContent += ` (Aviso: Falha ao buscar UF para o CEP ${cep})`; // Adiciona aviso
            lookupStatus.className = 'message success'; // Mantém sucesso, mas com aviso
            return null; // Retorna null em caso de erro
        } finally {
             ufLoader.style.display = 'none'; // Esconde spinner da UF
             if (ufInput) ufInput.disabled = false; // Reabilita campo UF
        }
    }


    // Função que preenche o formulário (agora ASYNC)
    async function populateFormWithPharmUpData(data) {
        clearAutoFilledFields();

        for (const jsonKey in fieldMapping) {
            // Não preenche UF diretamente aqui, será feito pela busca de CEP
            if (jsonKey === 'EnderecoEntrega.UF') continue;

            const formId = fieldMapping[jsonKey];
            const element = document.getElementById(formId);
            if (element && data[jsonKey] !== undefined && data[jsonKey] !== null) {
                 if (formId === 'valor_venda') {
                     element.value = String(data[jsonKey]).replace(',', '.');
                 }
                 else if (element.tagName === 'SELECT' && formId === 'marca') {
                     if (String(data.meta?.setorDescricao).toUpperCase() === 'NEUVYE' || String(data['LocalEntrega.Descricao']).toUpperCase().includes('NEUVYE')) {
                         element.value = 'Neuvye';
                     }
                 }
                 else if (formId !== 'endereco' && formId !== 'ordem_manipulacao') {
                    element.value = data[jsonKey];
                 }
                 // NÃO adiciona readonly aqui
            }
        }

        // Preenche Ordem de Manipulação com $M
        const ordemInput = document.getElementById('ordem_manipulacao');
        if (ordemInput) {
             const ordem = (data.itens && data.itens.length > 0) ? data.itens[0]['ManipulacaoOrdem.Codigo'] : null;
             if (ordem && ordem !== '0'){
                 ordemInput.value = `${ordem}$M`; // MUDANÇA: Adiciona $M
             } else {
                 ordemInput.value = '';
             }
             // ordemInput.readOnly = false; // Já é false por padrão
        }

        // Preenche Endereço Combinado (incluindo Bairro e CEP)
        const enderecoInput = document.getElementById('endereco');
        const cep = data['EnderecoEntrega.Cep'] || ''; // Pega o CEP
        if (enderecoInput) {
            const rua = data['EnderecoEntrega.Endereco'] || '';
            const num = data['EnderecoEntrega.Numero'] || '';
            const compl = data['EnderecoEntrega.Complemento'] || '';
            const bairro = data['EnderecoEntrega.Bairro'] || '';
            let enderecoCompleto = rua;
            if (num) enderecoCompleto += `, ${num}`;
            if (compl) enderecoCompleto += ` - ${compl}`;
            if (bairro) enderecoCompleto += `, ${bairro}`;
            if (cep) enderecoCompleto += `, CEP: ${cep}`; // MUDANÇA: Adiciona CEP
            enderecoInput.value = enderecoCompleto.trim();
            // enderecoInput.readOnly = false; // Já é false por padrão
        }

        // MUDANÇA: Chama a busca da UF pelo CEP
        const ufInput = document.getElementById('uf');
        if (ufInput) {
            const ufEncontrada = await fetchUfFromCep(cep);
            if (ufEncontrada) {
                ufInput.value = ufEncontrada;
            } else {
                ufInput.value = ''; // Limpa se não encontrar ou der erro
            }
            // ufInput.readOnly = false; // Já é false por padrão
        }
    }

    // Função que limpa os campos preenchidos automaticamente (garante editabilidade)
    function clearAutoFilledFields() {
         autoAffectedFields.forEach(id => {
             const element = document.getElementById(id);
             if(element) {
                 element.value = '';
                 element.readOnly = false; // Garante que fiquem editáveis
             }
         });
         // Volta a marca para o padrão Neuvye ao limpar
         const marcaSelect = document.getElementById('marca');
         if (marcaSelect) marcaSelect.value = 'Neuvye';
    }

     // Função que desabilita/Reabilita campos DURANTE A BUSCA PharmUp
    function disableFormFieldsDuringLookup(disabled) {
        buscarPharmUpBtn.disabled = disabled;
        codigoVendaInput.disabled = disabled;
        const saveButton = form.querySelector('button[type="submit"]');
        if (saveButton) saveButton.disabled = disabled;
    }


    // --- Função de Salvar (SUBMIT) ---
    form.addEventListener('submit', async (event) => {
        event.preventDefault();

        // No modo EDIÇÃO, habilita temporariamente os campos que estavam readonly
        let fieldsToReapplyReadonly = [];
        if (editMode) {
             fieldsToReapplyReadonly = JSON.parse(form.dataset.readonlyFields || '[]');
             fieldsToReapplyReadonly.forEach(id => {
                 const element = document.getElementById(id);
                 if (element) element.readOnly = false;
             });
             // Garante que o código de venda esteja habilitado para FormData
             if (codigoVendaInput.readOnly) codigoVendaInput.readOnly = false;
        }

        const formData = new FormData(form);
        const dataObject = Object.fromEntries(formData.entries());

        // Re-aplica `readOnly` e `disabled` (somente para Edição) se necessário
        if (editMode) {
             fieldsToReapplyReadonly.forEach(id => {
                 const element = document.getElementById(id);
                 if (element) element.readOnly = true;
             });
             codigoVendaInput.readOnly = true; // Sempre readonly na edição
        }

        let redirectUrl = '/index.html';

        successMessage.textContent = `Salvando venda...`;
        successMessage.className = 'message info';
        successMessage.style.display = 'block';
        form.querySelector('button[type="submit"]').disabled = true;

        try {
            let error;

            if (editMode) {
                const { error: updateError } = await supabase.functions.invoke('update-envio', { body: { id: parseInt(envioId), updates: dataObject } });
                error = updateError;
                redirectUrl = `vendas.html?janela=${encodeURIComponent(dataObject.janela_coleta || originalJanela)}`;
            } else {
                const { error: createError } = await supabase.functions.invoke('create-envio', { body: dataObject });
                error = createError;
            }

            if (error) {
                 const errorMsg = error.context?.json?.error || error.message || "Erro desconhecido ao salvar.";
                 throw new Error(errorMsg);
            };

            successMessage.textContent = `Venda ${editMode ? 'atualizada' : 'criada'} com sucesso! Redirecionando...`;
            successMessage.className = 'message success';
            successMessage.style.display = 'block';
            setTimeout(() => { window.location.href = redirectUrl; }, 2000);

        } catch (error) {
            alert(`Erro ao salvar: ${error.message}`);
             successMessage.style.display = 'none';
             form.querySelector('button[type="submit"]').disabled = false;

             // Re-aplica `readOnly` para o caso de erro, garantindo o estado original na edição
             if (editMode) {
                fieldsToReapplyReadonly.forEach(id => {
                     const element = document.getElementById(id);
                     if (element) element.readOnly = true;
                 });
                 codigoVendaInput.readOnly = true;
             }
        }
    });
</script>
</body>
</html>