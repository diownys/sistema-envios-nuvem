<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Venda</title>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f9; margin: 0; padding: 2rem; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: 1 / -1; }
        label { font-weight: bold; margin-bottom: 0.5rem; }
        input, select { padding: 0.8rem; border-radius: 5px; border: 1px solid #ccc; font-size: 1rem; }
        input:read-only { background-color: #e9ecef; cursor: not-allowed;} /* Estilo para campos preenchidos */
        .form-actions { margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem; }
        .btn { padding: 0.8rem 1.5rem; text-decoration: none; border-radius: 5px; color: white; border: none; cursor: pointer; font-size: 1rem; }
        .btn-save { background-color: #28a745; }
        .btn-cancel { background-color: #6c757d; }
        .message { font-weight: bold; margin-top: 1rem; padding: 0.5rem; border-radius: 4px; }
        .message.success { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb;}
        .message.error { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb;}
        .message.info { color: #0c5460; background-color: #d1ecf1; border: 1px solid #bee5eb;}

        /* Estilo para loading spinner (opcional) */
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 20px; height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block; margin-left: 10px; vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="page-title">Carregando Formulário...</h1>
        <div id="lookup-status" class="message" style="display: none;"></div>

        <form id="envio-form">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label for="marca">Marca</label>
                    <select id="marca" name="marca" required>
                        <option value="Neuvye">Neuvye</option>
                        <option value="DrogaVET">DrogaVET</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="codigo_venda">Código da Venda (PharmUp)</label>
                    <input type="text" id="codigo_venda" name="codigo_venda" required>
                    <button type="button" id="buscar-pharmup-btn" style="margin-top: 5px; width: auto; background-color: #007bff;">Buscar Dados PharmUp</button>
                 </div>
                <div class="form-group"><label for="ordem_manipulacao">Ordem de Manipulação</label><input type="text" id="ordem_manipulacao" name="ordem_manipulacao" readonly></div>
                <div class="form-group full-width"><label for="cliente_nome">Nome do Cliente</label><input type="text" id="cliente_nome" name="cliente_nome" required readonly></div>
                <div class="form-group"><label for="valor_venda">Valor da Venda (R$)</label><input type="text" id="valor_venda" name="valor_venda" required readonly></div>
                <div class="form-group"><label for="volumes">Volumes</label><input type="number" id="volumes" name="volumes" value="1" required></div>
                
                <div class="form-group"><label for="janela_coleta">Janela/Local de Coleta</label><input type="text" id="janela_coleta" name="janela_coleta" required readonly></div>
                
                <div class="form-group full-width"><label for="endereco">Endereço (Rua, Nº - Compl.)</label><input type="text" id="endereco" name="endereco" readonly></div>
                <div class="form-group"><label for="cidade">Cidade</label><input type="text" id="cidade" name="cidade" readonly></div>
                <div class="form-group"><label for="numero_nota">Número da Nota</label><input type="text" id="numero_nota" name="numero_nota"></div>
            </div>
            <div class="form-actions">
                <a href="/index.html" id="cancel-link" class="btn btn-cancel">Cancelar</a>
                <button type="submit" class="btn btn-save">Salvar</button>
            </div>
        </form>
        <div id="success-message" class="message success" style="display: none;"></div>
    </div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const SUPABASE_URL = 'https://nfsuisftzddegihyhoha.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mc3Vpc2Z0emRkZWdpaHlob2hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMTcwMDcsImV4cCI6MjA3NDU5MzAwN30.tM_9JQo6ejzOBWKQ9XxT54f8NuM6jSoHomF9c_IfEJI';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const form = document.getElementById('envio-form');
    const pageTitle = document.getElementById('page-title');
    const successMessage = document.getElementById('success-message');
    const lookupStatus = document.getElementById('lookup-status'); // Mensagem da busca
    const codigoVendaInput = document.getElementById('codigo_venda'); // Input do código
    const buscarPharmUpBtn = document.getElementById('buscar-pharmup-btn'); // Botão de busca manual

    // Mapeamento dos campos JSON para IDs do formulário
    const fieldMapping = {
        'Cliente.Nome': 'cliente_nome',
        'ValorFinal': 'valor_venda', // Necessita formatação , -> .
        'LocalEntrega.Descricao': 'janela_coleta',
        'EnderecoEntrega.Cidade': 'cidade',
        // Campos que precisam de tratamento especial:
        'ordem_manipulacao': 'ordem_manipulacao', // Vem de itens[0]
        'endereco': 'endereco', // Combinação de campos
        'marca': 'marca' // Campo Select
    };
    
    // Lista de IDs dos campos que serão preenchidos automaticamente
    const autoFilledFields = ['ordem_manipulacao', 'cliente_nome', 'valor_venda', 'janela_coleta', 'endereco', 'cidade'];


    let editMode = false;
    let envioId = null;
    let originalJanela = '';

    document.addEventListener('DOMContentLoaded', async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) { window.location.href = '/login.html'; return; }

        const params = new URLSearchParams(window.location.search);
        envioId = params.get('id');

        if (envioId) {
            editMode = true;
            pageTitle.textContent = 'Editar Venda';
            // Desabilita busca automática na edição para não sobrescrever dados já salvos
            codigoVendaInput.readOnly = true; 
            buscarPharmUpBtn.style.display = 'none'; // Esconde botão de busca
            lookupStatus.style.display = 'none'; // Esconde status da busca
            await fetchAndPopulateForm(envioId);
        } else {
            editMode = false;
            pageTitle.textContent = 'Adicionar Nova Venda';
            document.getElementById('cancel-link').href = '/index.html';
            // Habilita busca automática no modo de adição
            // codigoVendaInput.addEventListener('blur', handleCodigoVendaBlur); // Disparar ao sair do campo
            buscarPharmUpBtn.addEventListener('click', handleCodigoVendaBlur); // Ou ao clicar no botão
            // Marcar campos como não-readonly inicialmente
             autoFilledFields.forEach(id => {
                const element = document.getElementById(id);
                if(element) element.readOnly = false;
             });
        }
    });

    async function fetchAndPopulateForm(id) {
        try {
            const { data, error } = await supabase.functions.invoke('get-envio-by-id', { body: { id: parseInt(id) } });
            if (error) throw error;
            const envio = data.envio;
            
            for (const key in envio) {
                const input = document.getElementById(key);
                if (input) input.value = envio[key];
            }
            pageTitle.textContent = `Editar Venda #${envio.codigo_venda}`;
            originalJanela = envio.janela_coleta;
            document.getElementById('cancel-link').href = `vendas.html?janela=${encodeURIComponent(originalJanela)}`;

            // Marcar campos preenchidos como readonly na edição (exceto os que podem mudar)
            autoFilledFields.forEach(id => {
                const element = document.getElementById(id);
                if(element) element.readOnly = true;
            });

        } catch (error) {
            alert(`Erro ao carregar dados da venda: ${error.message}`);
        }
    }

    // --- NOVA FUNÇÃO: Lida com a busca no PharmUp ---
    async function handleCodigoVendaBlur() {
        const codigo = codigoVendaInput.value.trim();
        if (!codigo) {
            clearAutoFilledFields(); // Limpa campos se o código for apagado
            lookupStatus.style.display = 'none';
            return;
        }

        lookupStatus.innerHTML = 'Buscando dados no PharmUp... <div class="loader"></div>';
        lookupStatus.className = 'message info';
        lookupStatus.style.display = 'block';
        disableFormFields(true); // Desabilita campos durante a busca

        try {
            const { data, error } = await supabase.functions.invoke('buscador-vendas', {
                body: { codigoVenda: codigo }
            });

            // Erro retornado pela função (incluindo 404 - não encontrado)
            if (error) {
                 // Verifica se é o erro específico de "não encontrado" que definimos com status 404
                 if (error.context && error.context.status === 404) {
                     throw new Error(error.context.json.error || "Venda não encontrada no PharmUp.");
                 } else {
                    // Outros erros (500, etc)
                    throw new Error(error.context?.json?.error || error.message || "Erro desconhecido ao buscar dados.");
                 }
            }
            
            // Sucesso - Preenche o formulário
            populateFormWithPharmUpData(data);
            lookupStatus.textContent = 'Dados carregados do PharmUp com sucesso!';
            lookupStatus.className = 'message success';

        } catch (err) {
            console.error('Erro na busca PharmUp:', err);
            lookupStatus.textContent = `Erro: ${err.message}`;
            lookupStatus.className = 'message error';
            clearAutoFilledFields(); // Limpa campos em caso de erro

        } finally {
            disableFormFields(false); // Reabilita campos
        }
    }

    // --- NOVA FUNÇÃO: Preenche o formulário com dados do JSON ---
    function populateFormWithPharmUpData(data) {
        // Preenche campos diretos
        for (const jsonKey in fieldMapping) {
            const formId = fieldMapping[jsonKey];
            const element = document.getElementById(formId);
            if (element && data[jsonKey] !== undefined && data[jsonKey] !== null) {
                 // Tratamento especial para valor (trocar vírgula por ponto)
                 if (formId === 'valor_venda') {
                     element.value = String(data[jsonKey]).replace(',', '.');
                 } 
                 // Tratamento para SELECT (marca)
                 else if (element.tagName === 'SELECT' && formId === 'marca') {
                     // Tenta setar para Neuvye se encontrar, senão mantém o padrão
                     if (String(data.meta?.setorDescricao).toUpperCase() === 'NEUVYE' || String(data['LocalEntrega.Descricao']).toUpperCase().includes('NEUVYE')) {
                         element.value = 'Neuvye';
                     } 
                     // Adicione mais lógicas aqui se precisar identificar DrogaVET
                 }
                 // Campos normais
                 else if (formId !== 'endereco' && formId !== 'ordem_manipulacao') { // Ignora os especiais por enquanto
                    element.value = data[jsonKey];
                 }
                 // Marca como readonly após preencher
                 if(autoFilledFields.includes(formId)) {
                    element.readOnly = true;
                 }
            }
        }

        // Preenche Ordem de Manipulação (primeiro item)
        const ordemInput = document.getElementById('ordem_manipulacao');
        if (ordemInput && data.itens && data.itens.length > 0) {
            const ordem = data.itens[0]['ManipulacaoOrdem.Codigo'];
             if (ordem && ordem !== '0'){ // Só preenche se não for '0'
                 ordemInput.value = ordem;
             } else {
                 ordemInput.value = ''; // Deixa em branco se for '0'
             }
            ordemInput.readOnly = true;
        } else if (ordemInput) {
             ordemInput.value = ''; // Limpa se não houver itens
             ordemInput.readOnly = true;
        }


        // Preenche Endereço Combinado
        const enderecoInput = document.getElementById('endereco');
        if (enderecoInput) {
            const rua = data['EnderecoEntrega.Endereco'] || '';
            const num = data['EnderecoEntrega.Numero'] || '';
            const compl = data['EnderecoEntrega.Complemento'] || '';
            let enderecoCompleto = rua;
            if (num) enderecoCompleto += `, ${num}`;
            if (compl) enderecoCompleto += ` - ${compl}`;
            enderecoInput.value = enderecoCompleto.trim();
            enderecoInput.readOnly = true;
        }
         // O campo volumes não será preenchido automaticamente, mantém o default 1
         // O campo numero_nota não vem da API de busca, então não será preenchido
    }

    // --- NOVA FUNÇÃO: Limpa os campos preenchidos automaticamente ---
    function clearAutoFilledFields() {
         autoFilledFields.forEach(id => {
             const element = document.getElementById(id);
             if(element) {
                 element.value = '';
                 element.readOnly = false; // Permite edição manual se a busca falhar
             }
         });
         // Limpa também o select de marca? Ou deixa como está? Decidi deixar.
         // const marcaSelect = document.getElementById('marca');
         // if (marcaSelect) marcaSelect.value = 'Neuvye'; // Volta pro default?
    }

     // --- NOVA FUNÇÃO: Desabilita/Reabilita campos durante a busca ---
    function disableFormFields(disabled) {
        // Desabilita/Reabilita todos os inputs preenchidos + botão buscar + botão salvar
        [codigoVendaInput, buscarPharmUpBtn, ...autoFilledFields.map(id => document.getElementById(id))].forEach(el => {
            if(el) el.disabled = disabled;
        });
        // Também desabilita o botão Salvar principal
         const saveButton = form.querySelector('button[type="submit"]');
         if (saveButton) saveButton.disabled = disabled;
    }


    // --- Função de Salvar (SUBMIT) ---
    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        
        // Habilita temporariamente os campos readonly para pegar os valores
        autoFilledFields.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.readOnly = false;
        });

        const formData = new FormData(form);
        const dataObject = Object.fromEntries(formData.entries());

        // Desabilita novamente (se for edição) ou mantém habilitado (se for novo e busca falhou)
         if (editMode) {
             autoFilledFields.forEach(id => {
                 const element = document.getElementById(id);
                 if (element) element.readOnly = true;
             });
         } else {
             // Se dadosVendaAtual existe, significa que a busca deu certo, então re-aplica readonly
             if (dadosVendaAtual) {
                 autoFilledFields.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.readOnly = true;
                 });
             }
         }


        let redirectUrl = '/index.html';

        // Mostra mensagem de salvando...
        successMessage.textContent = `Salvando venda...`;
        successMessage.className = 'message info';
        successMessage.style.display = 'block';
        form.querySelector('button[type="submit"]').disabled = true; // Desabilita salvar


        try {
            let error;
            
            if (editMode) {
                const { error: updateError } = await supabase.functions.invoke('update-envio', { body: { id: parseInt(envioId), updates: dataObject } });
                error = updateError;
                redirectUrl = `vendas.html?janela=${encodeURIComponent(dataObject.janela_coleta || originalJanela)}`;
            } else {
                const { error: createError } = await supabase.functions.invoke('create-envio', { body: dataObject });
                error = createError;
            }

            if (error) {
                 const errorMsg = error.context?.json?.error || error.message || "Erro desconhecido ao salvar.";
                 throw new Error(errorMsg);
            };
            
            successMessage.textContent = `Venda ${editMode ? 'atualizada' : 'criada'} com sucesso! Redirecionando...`;
            successMessage.className = 'message success'; // Muda para classe de sucesso
            successMessage.style.display = 'block';
            setTimeout(() => { window.location.href = redirectUrl; }, 2000);

        } catch (error) {
            alert(`Erro ao salvar: ${error.message}`);
             successMessage.style.display = 'none'; // Esconde mensagem de salvando
             form.querySelector('button[type="submit"]').disabled = false; // Reabilita salvar
        }
    });
</script>
</body>
</html>