<!DOCTYPE html>
<html lang="pt-br">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Confer√™ncia - Sistema de Envios</title>
 
 <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
 
 <style>
  /* Estilos do seu login.html */
  body { font-family: sans-serif; background-color: #f4f4f9; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 2rem 0; }
  .conferencia-container { background: white; padding: 2rem 3rem; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 600px; }
  h1 { color: #333; margin-bottom: 1.5rem; }
  h2 { color: #555; margin-bottom: 1rem; border-top: 1px solid #eee; padding-top: 1.5rem; }

  /* Estilos da confer√™ncia */
  #scanner {
   width: 100%;
   max-width: 500px;
   margin: 0 auto;
   border: 1px solid #ddd;
   border-radius: 8px;
   overflow: hidden;
  }
  
  .resultado-message {
   color: #dc3545;
   margin-top: 1rem;
   min-height: 1.2em;
   font-size: 1.1rem;
   font-weight: bold;
  }

  #lista-conferencia {
   text-align: left;
   margin-top: 1rem;
  }

  .item-venda {
   padding: 12px;
   border: 1px solid #ddd;
   margin-bottom: 8px;
   border-radius: 5px;
   display: flex;
   align-items: center;
   transition: background-color 0.3s;
  }

  .status {
   display: inline-block;
   width: 15px;
   height: 15px;
   border-radius: 50%;
   margin-right: 12px;
   flex-shrink: 0;
  }

  .pendente { background-color: orange; }
  .concluido { background-color: #28a745; }

  .item-venda span {
   font-size: 0.9rem;
   color: #666;
   margin-left: auto;
  }

  /* ===== ESTILO PARA INPUT MANUAL (ADMIN) ===== */
  #manual-input-container {
   display: none; /* ESCONDIDO POR PADR√ÉO */
   margin-top: 1.5rem;
   border-top: 1px solid #eee;
   padding-top: 1.5rem;
   text-align: left;
  }
  #manual-input-container label {
   display: block;
   margin-bottom: 0.5rem;
   color: #555;
  }
  #manual-qrcode {
   width: 100%;
   padding: 0.8rem;
   border: 1px solid #ddd;
   border-radius: 5px;
   box-sizing: border-box; 
  }
  #manual-submit {
   width: 100%;
   padding: 0.9rem;
   background-color: #6c757d; /* Cinza Admin */
   color: white;
   border: none;
   border-radius: 5px;
   font-size: 1rem;
   font-weight: bold;
   cursor: pointer;
   transition: background-color 0.2s;
   margin-top: 0.5rem; 
  }
  #manual-submit:hover {
   background-color: #5a6268;
  }
    
    /* ===== NOVO ESTILO PARA BOT√ÉO RESET (ADMIN) ===== */
    #reset-lote-btn {
        width: 100%;
        padding: 0.9rem;
        background-color: #dc3545; /* Vermelho Perigo */
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s;
        margin-top: 0.5rem;
    }
    #reset-lote-btn:hover {
        background-color: #c82333;
    }

    /* ===== NOVO ESTILO PARA BOT√ÉO ROMANEIO (GERAL) ===== */
    #gerar-romaneio-btn {
        width: 100%;
        padding: 0.9rem;
        background-color: #007bff; /* Azul Prim√°rio */
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    #gerar-romaneio-btn:hover {
        background-color: #0056b3;
    }

 </style>
</head>
<body>
 
 <div class="conferencia-container">
  <h1>Confer√™ncia de Lote</h1>
  
  <div id="scanner"></div>
  <div id="resultado" class="resultado-message"></div>

  <div id="manual-input-container">
   <label for="manual-qrcode">Entrada Manual (Admin)</label>
   <input type="text" id="manual-qrcode" placeholder="Digite o QR Code..."/>
   <button id="manual-submit">Conferir Manualmente</button>
      
      <button id="reset-lote-btn">Resetar Lote</button>

  </div>
  <h2>Lista de Confer√™ncia (Realtime)</h2>

      <div id="romaneio-container" style="margin-bottom: 1rem;"></div>

  <div id="lista-conferencia">Carregando lista...</div>
 </div>

 <script type="module">
  // 2. Importar o Supabase-JS (como no seu login)
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  // === CONFIGURA√á√ÉO ===
  const SUPABASE_URL = 'https://nfsuisftzddegihyhoha.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mc3Vpc2Z0emRkZWdpaHlob2hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMTcwMDcsImV4cCI6MjA3NDU5MzAwN30.tM_9JQo6ejzOBWKQ9XxT54f8NuM6jSoHomF9c_IfEJI';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  const urlParams = new URLSearchParams(window.location.search);
  const LOTE_ID_PARA_TESTAR = urlParams.get('lote_id'); 
  
  if (!LOTE_ID_PARA_TESTAR) {
   alert("ID do Lote n√£o encontrado! Retornando para a sele√ß√£o.");
   window.location.href = '/selecao-lote.html'; 
  }
  // =============================================

  // 4. Refer√™ncias dos Elementos
  const divLista = document.getElementById('lista-conferencia');
  const divResultado = document.getElementById('resultado');
  const manualInputContainer = document.getElementById('manual-input-container');
  const manualInput = document.getElementById('manual-qrcode');
  const manualSubmit = document.getElementById('manual-submit');
    // ===== NOVA REFER√äNCIA PARA O ROMANEIO =====
    const romaneioContainer = document.getElementById('romaneio-container');
  
  // 5. Fun√ß√£o para desenhar a lista na tela (ATUALIZADA)
  async function renderizarLista() {
   divLista.innerHTML = "Atualizando...";
      // ===== NOVO: Limpa o bot√£o de romaneio
      romaneioContainer.innerHTML = ""; 
   
   const { data, error } = await supabase.rpc('get_status_conferencia_lote', {
    p_lote_id: LOTE_ID_PARA_TESTAR
   });
   
   if (error) {
    divLista.innerHTML = `Erro ao buscar lista: ${error.message}`;
    return;
   }
   
   if (!data || data.length === 0) {
    divLista.innerHTML = "Nenhum item encontrado para este lote. (Pode j√° ter sido conferido)";
    return;
   }

   let html = '';
      // ===== NOVO: Flag para checar se tudo est√° üü¢
      let todosConcluidos = true;

   for (const item of data) {
    const isConcluido = item.volumes_conferidos === item.volumes_totais;
        
        // ===== NOVO: Se acharmos UM item n√£o conclu√≠do, a flag fica falsa
        if (!isConcluido) {
          todosConcluidos = false;
        }

    const statusClass = isConcluido ? 'concluido' : 'pendente';
    const statusDot = `<span class="status ${statusClass}"></span>`;
    
    if (isConcluido) {
     html += `<div class="item-venda" style="background-color: #f0fff4;">`;
    } else {
     html += `<div class="item-venda">`;
    }

    html += `
      ${statusDot}
      <strong>${item.venda_numero_display}</strong> 
      (${item.cliente_nome_display || 'Cliente'})
      <span>${item.volumes_conferidos} / ${item.volumes_totais}</span>
     </div>
    `;
   }
   divLista.innerHTML = html;

      // ===== NOVO: L√ìGICA PARA MOSTRAR O BOT√ÉO DE ROMANEIO =====
      if (todosConcluidos && data.length > 0) {
        romaneioContainer.innerHTML = `
          <p style="color: #28a745; font-weight: bold;">Todos os itens conferidos!</p>
          <button id="gerar-romaneio-btn">
            Gerar Romaneio
          </button>
        `;
        
        // Adiciona o clique ao bot√£o que acabamos de criar
        document.getElementById('gerar-romaneio-btn').onclick = () => {
          // (Quando tivermos o romaneio.html, mudamos aqui)
          alert("Pronto para gerar o Romaneio!");
          // window.open(`/romaneio.html?lote_id=${LOTE_ID_PARA_TESTAR}`, '_blank');
        };
      }
  }

  // 6. Fun√ß√£o onScanSuccess (NENHUMA MUDAN√áA AQUI)
  async function onScanSuccess(qrCodeLido, decodedResult) {
   divResultado.style.color = '#007bff'; // Azul (Processando)
   divResultado.innerHTML = `Lido: ${qrCodeLido}. Processando...`;

   try {
    const response = await fetch('https://nfsuisftzddegihyhoha.supabase.co/functions/v1/conferir-volume', {
     method: 'POST',
     headers: { 
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
     },
     body: JSON.stringify({
      qr_code: qrCodeLido,
      lote_id: LOTE_ID_PARA_TESTAR
     })
    });
    
    const result = await response.json();

    if (response.ok) {
     divResultado.style.color = '#28a745'; // Verde
     divResultado.innerHTML = `SUCESSO: ${result.message}`;
    } else {
     divResultado.style.color = '#dc3545'; // Vermelho
     divResultado.innerHTML = `ERRO: ${result.message}`;
    }

   } catch (err) {
    divResultado.style.color = '#dc3545'; // Vermelho
    divResultado.innerHTML = `ERRO ao chamar API: ${err.message}`;
   }
   
   manualInput.value = '';
  }
  
  // 7. Fun√ß√£o para escutar mudan√ßas em Realtime (NENHUMA MUDAN√áA AQUI)
    // (Agora deve funcionar, gra√ßas ao SQL da Parte 1)
  function escutarRealtime() {
   supabase
    .channel('conferencia-realtime')
    .on('postgres_changes', 
     { 
      event: 'UPDATE', 
      schema: 'public', 
      table: 'volumes_conferencia',
      filter: `lote_id=eq.${LOTE_ID_PARA_TESTAR}`
     },
     (payload) => {
      console.log('Mudan√ßa recebida!', payload);
            // AGORA SIM: Isso vai ser chamado e vai atualizar a lista
      renderizarLista(); 
     }
    )
    .subscribe();
  }

  // ===== FUN√á√ÉO DE CHECAR ADMIN (ATUALIZADA) =====
  async function checkUserRole() {
   const { data: { session } } = await supabase.auth.getSession();
   if (!session) {
    console.log("Nenhuma sess√£o encontrada, redirecionando para login...");
    window.location.href = '/login.html'; 
    return;
   }
   
   const { data: profile, error } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', session.user.id)
    .single();
   
   if (error) {
    console.warn("Aviso: Erro ao buscar perfil do usu√°rio. Campo admin n√£o ser√° exibido.", error.message);
    return; 
   }

   // Se for admin, MOSTRA o campo de input manual
   if (profile && profile.role === 'admin') {
    console.log("Usu√°rio √© admin, mostrando campo manual.");
    manualInputContainer.style.display = 'block';

        // ===== NOVO: L√ìGICA DE CLIQUE DO RESET (ADMIN) =====
        document.getElementById('reset-lote-btn').onclick = async () => {
          if (!confirm('Tem certeza que deseja resetar este lote? Todos os volumes voltar√£o para "pendente".')) {
            return;
          }
          
          divResultado.style.color = '#007bff';
          divResultado.innerHTML = 'Resetando lote...';

          // Chama a fun√ß√£o SQL que criamos na Parte 2
          const { data, error } = await supabase.rpc('resetar_lote_conferencia', {
            p_lote_id: LOTE_ID_PARA_TESTAR
          });

          if (error) {
            divResultado.style.color = '#dc3545';
            divResultado.innerHTML = `Erro ao resetar: ${error.message}`;
          } else {
            divResultado.style.color = '#28a745';
            divResultado.innerHTML = data; // Mostra "Lote resetado com sucesso!"
            // Manda renderizar a lista de novo para vermos tudo üü†
            renderizarLista(); 
          }
        };
        // ==========================================
   }
  }

  // ===== Bot√£o de Submit Manual (SEM MUDAN√áA) =====
  manualSubmit.onclick = () => {
   const qrCodeManual = manualInput.value.trim();
   if (qrCodeManual) {
    onScanSuccess(qrCodeManual, null); 
   } else {
    divResultado.style.color = '#dc3545';
    divResultado.innerHTML = `ERRO: Campo manual est√° vazio.`;
   }
  };
  
  manualInput.addEventListener('keydown', (e) => {
   if (e.key === 'Enter') {
    e.preventDefault(); 
    manualSubmit.click();
   }
  });

  // 8. Inicializar o Scanner (SEM MUDAN√áA)
  const html5QrCode = new Html5Qrcode("scanner");
  html5QrCode.start(
   { facingMode: "environment" },
   {
    fps: 5,
    qrbox: (viewfinderWidth, viewfinderHeight) => {
     const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
     const qrboxSize = Math.floor(minEdge * 0.7);
     return { width: qrboxSize, height: qrboxSize };
    }
   },
   onScanSuccess,
   (errorMessage) => { /* ignora erros de scan */ }
  ).catch(err => {
   document.getElementById("scanner").innerHTML = "Erro ao iniciar a c√¢mera: " + err.message;
  });

  // 9. Iniciar tudo
  checkUserRole(); // Verifica o login e o status de admin
 M renderizarLista(); // Renderiza a lista inicial
  escutarRealtime(); // Escuta por mudan√ßas

 </script>
</body>
</html>