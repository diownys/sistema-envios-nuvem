<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Selecionar Lote - Sistema de Envios</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<style>
 body { font-family: sans-serif; background-color: #f4f4f9; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 2rem 0; }
 .container { background: white; padding: 2rem 3rem; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 500px; }
 h1 { color: #333; margin-bottom: 0.5rem; }
 h2 { color: #666; font-size: 1.1rem; margin-top: 0; margin-bottom: 1.5rem; font-weight: 400; }
 #lista-janelas { max-height: 400px; overflow-y: auto; }
 .janela-button {
 display: block; width: 100%; padding: 1rem; margin-bottom: 0.5rem;
 background-color: #007bff; color: white; border: none; border-radius: 5px;
 font-size: 1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s;
 box-sizing: border-box;
 }
 .janela-button:hover { background-color: #0056b3; }
 .janela-button:disabled { background-color: #ccc; }
 #status { margin-top: 1rem; color: #555; }
 .back-link { margin-top: 1.5rem; display: block; color: #666; text-decoration: none; font-size: 0.9rem; }

 /* Painel de Admin */
 .admin-container {
 background: #fff8e1;
 border: 1px solid #ffecb3;
 padding: 1.5rem 2rem;
 border-radius: 8px;
 box-shadow: 0 2px 4px rgba(0,0,0,0.05);
 width: 100%;
 max-width: 700px;
 margin-top: 2rem;
 box-sizing: border-box;
 }
 .admin-container h3 { margin-top: 0; color: #c07d00; border-bottom: 2px solid #ffecb3; padding-bottom: 0.5rem; }
 .admin-list { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; }
 .admin-item {
 display: flex; justify-content: space-between; align-items: center;
 padding: 0.75rem 0.5rem; border-bottom: 1px solid #eee; font-size: 0.9rem; flex-wrap: wrap;
 }
 .revert-button {
 background-color: #e53935; color: white; border: none; border-radius: 4px;
 padding: 0.4rem 0.8rem; font-size: 0.85rem; cursor: pointer;
 }
 .revert-button:hover { background-color: #c62828; }
</style>
</head>
<body>
<div class="container">
 <h1>Selecionar Janela</h1>
 <h2 id="data-hoje"></h2>
 <div id="lista-janelas">
 <p id="status">Carregando janelas para conferência...</p>
 </div>
 <a href="index.html" class="back-link">← Voltar ao Dashboard</a>
</div>

<div id="admin-panel-placeholder"></div>

<script>
 const { createClient } = window.supabase;

 const SUPABASE_URL = 'https://nfsuisftzddegihyhoha.supabase.co';
 const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mc3Vpc2Z0emRkZWdpaHlob2hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMTcwMDcsImV4cCI6MjA3NDU5MzAwN30.tM_9JQo6ejzOBWKQ9XxT54f8NuM6jSoHomF9c_IfEJI';
 
 // Uso padronizado de supabaseClient
 const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

 const divLista = document.getElementById('lista-janelas');
 const pStatus = document.getElementById('status');
 const h2Data = document.getElementById('data-hoje');
 const adminPanelPlaceholder = document.getElementById('admin-panel-placeholder');

 async function carregarJanelas() {
  const hoje = new Date();
  hoje.setHours(0, 0, 0, 0); 
  const amanha = new Date(hoje);
  amanha.setDate(amanha.getDate() + 1);

  h2Data.innerText = `Envios de: ${hoje.toLocaleDateString('pt-BR')}`;
  
  const hojeISO = hoje.toISOString();
  const amanhaISO = amanha.toISOString();

  const { data, error } = await supabaseClient
   .from('envios')
   .select('janela_coleta')
   .eq('status', 'Confirmado')
   .gte('created_at', hojeISO)
   .lt('created_at', amanhaISO);

  if (error) {
   pStatus.innerText = `Erro ao buscar janelas: ${error.message}`;
   return;
  }

  const janelasUnicas = [...new Set(data.map(item => item.janela_coleta || 'Sem Janela Definida'))];
  
  if (janelasUnicas.length === 0) {
   pStatus.innerText = "Nenhum envio 'Confirmado' encontrado para hoje.";
  } else {
   pStatus.remove(); 
   divLista.innerHTML = ''; 
   janelasUnicas.sort().forEach(nomeJanela => { 
    const button = document.createElement('button');
    button.className = 'janela-button';
    button.innerText = nomeJanela; 
    button.onclick = () => selecionarJanela(button, nomeJanela);
    divLista.appendChild(button);
   });
  }
  
  verificarAdminEExibirPainel(hojeISO, amanhaISO);
 }

 async function selecionarJanela(button, nomeJanela) {
  button.disabled = true;
  button.innerText = 'Processando...';

  // RPC que agrupa os envios da janela em um novo ID de Lote
  const { data: lote_id, error } = await supabaseClient.rpc('criar_lote_pela_janela', {
   p_janela_nome: nomeJanela
  });

  if (error) {
   console.error('Erro ao criar lote:', error);
   alert('Erro ao criar lote: ' + error.message);
   button.innerText = nomeJanela;
   button.disabled = false;
   return;
  }
  
  // Redireciona para a página de conferência com o ID do lote gerado
  window.location.href = `conferencia.html?lote_id=${lote_id}`;
 }

 // --- LÓGICA DE ADMIN (CORREÇÃO) ---

 async function verificarAdminEExibirPainel(hojeISO, amanhaISO) {
  const { data: { user } } = await supabaseClient.auth.getUser();
  if (!user) return;

  const { data: profile } = await supabaseClient
   .from('profiles')
   .select('role')
   .eq('id', user.id)
   .single();

  if (profile?.role === 'admin') {
   carregarEnviosParaCorrecao(hojeISO, amanhaISO);
  }
 }

 async function carregarEnviosParaCorrecao(hojeISO, amanhaISO) {
  const { data: envios, error } = await supabaseClient
   .from('envios')
   .select('id, codigo_venda, cliente_nome, janela_coleta, volumes')
   .eq('status', 'Confirmado')
   .gte('created_at', hojeISO)
   .lt('created_at', amanhaISO)
   .order('janela_coleta', { ascending: true });

  if (error || envios.length === 0) return;

  let adminHTML = `
   <div class="admin-container">
   <h3>Painel de Correção (Admin)</h3>
   <ul class="admin-list">
  `;

  envios.forEach(envio => {
   adminHTML += `
    <li class="admin-item">
     <div>
      <b>${envio.janela_coleta || 'N/D'}:</b> ${envio.codigo_venda} (${envio.volumes} vol)
     </div>
     <button class="revert-button" onclick="reverterEnvio('${envio.id}', this)">
       Reverter
     </button>
    </li>
   `;
  });

  adminHTML += `</ul></div>`;
  adminPanelPlaceholder.innerHTML = adminHTML;
 }

 async function reverterEnvio(envioId, button) {
  if (!confirm('Reverter este envio para "Pendente"?')) return;

  button.disabled = true;
  button.innerText = '...';

  const { error } = await supabaseClient.functions.invoke('reverter-envio', {
   body: { envio_id: parseInt(envioId) } 
  });

  if (error) {
   alert(`Erro: ${error.message}`);
   button.disabled = false;
   button.innerText = 'Reverter';
  } else {
   alert('Envio revertido!');
   window.location.reload();
  }
 }

 carregarJanelas();
</script>
</body>
</html>