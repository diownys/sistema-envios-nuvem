<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Teste da Função (Nota Simplificada)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; display: flex; gap: 40px; }
    .col-form { flex: 1; }
    .col-resultado { flex: 2; }
    input, button { font-size: 16px; padding: 8px; margin: 5px; }
    input[type="date"] { width: 150px; }
    #codigoVenda { width: 250px; }
    pre { background-color: #f4f4f4; border: 1px solid #ddd; padding: 10px; max-height: 400px; overflow-y: auto; }
    
    /* Estilos da Etiqueta de Teste */
    #etiqueta-teste-container {
      border: 2px dashed #999;
      padding: 15px;
      margin-top: 10px;
      width: 400px;
      background: #fff;
    }
    #etiqueta-teste-container h4 { margin-top: 0; }
    #etiqueta-teste-container p { margin: 4px 0; font-size: 14px; }
    #etiqueta-teste-container .destinatario {
      border-bottom: 1px solid #ccc;
      padding-bottom: 10px;
      margin-bottom: 10px;
    }
    #etiqueta-teste-container .itens { font-size: 13px; }
    #etiqueta-teste-container .itens li { margin-bottom: 5px; }
  </style>
</head>
<body>

  <div class="col-form">
    <h2>Teste por Cód. Venda</h2>
    
    <div>
      <label for="codigoVenda">Código da Venda:</label><br>
      <input type="text" id="codigoVenda" placeholder="Digite o código da venda...">
    </div>
    
    <div>
      <label for="de">De:</label><br>
      <input type="date" id="de">
    </div>
    
    <div>
      <label for="ate">Até:</label><br>
      <input type="date" id="ate">
    </div>
    
    <button id="btnTestar">Testar Função</button>

    <h3>Etiqueta de Teste:</h3>
    <div id="etiqueta-teste-container" style="display: none;">
      (Aguardando dados...)
    </div>
  </div>

  <div class="col-resultado">
    <h3>Resultado JSON:</h3>
    <pre id="resultado">(Aguardando teste...)</pre>
  </div>

  <script>
    // 2. Configure com suas chaves do Supabase
    const SUPABASE_URL = 'https://nfsuisftzddegihyhoha.supabase.co'; // <-- Substitua
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mc3Vpc2Z0emRkZWdpaHlob2hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMTcwMDcsImV4cCI6MjA3NDU5MzAwN30.tM_9JQo6ejzOBWKQ9XxT54f8NuM6jSoHomF9c_IfEJI'; // <-- Substitua
    
    // 3. Inicialize o cliente (com a correção do window.)
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 4. Seleciona os elementos da página
    const btnTestar = document.getElementById('btnTestar');
    const inputCodigoVenda = document.getElementById('codigoVenda'); // MUDADO
    const inputDe = document.getElementById('de');
    const inputAte = document.getElementById('ate');
    const output = document.getElementById('resultado');
    const etiquetaContainer = document.getElementById('etiqueta-teste-container');

    // 5. Define datas padrão (últimos 30 dias)
    const hoje = new Date();
    const dataFim = hoje.toISOString().split('T')[0]; // "YYYY-MM-DD"
    hoje.setDate(hoje.getDate() - 30);
    const dataIni = hoje.toISOString().split('T')[0]; // "YYYY-MM-DD"
    inputDe.value = dataIni;
    inputAte.value = dataFim;

    // NOVO: Função para renderizar a etiqueta
    function mostrarEtiquetaTeste(data) {
      const dest = data.destinatario;
      
      // Gera a lista de itens
      const itensHtml = data.itens.map(item => 
        `<li>(${item.qCom}x) ${item.xProd}</li>`
      ).join('');

      etiquetaContainer.innerHTML = `
        <div class="destinatario">
          <h4>DESTINATÁRIO:</h4>
          <p><strong>${dest.xNome}</strong></p>
          <p>${dest.ender.xLgr || ''}, ${dest.ender.nro || ''}</p>
          <p>${dest.ender.xBairro || ''} - ${dest.ender.xMun || ''}/${dest.ender.UF || ''}</p>
          <p>CEP: ${dest.ender.CEP || ''}</p>
        </div>
        <div class="itens">
          <strong>Itens:</strong>
          <ul>${itensHtml}</ul>
        </div>
        <div class="nota-info">
          <p><small>Nota: ${data.numero} | Chave: ${data.chave.substring(0, 22)}...</small></p>
        </div>
      `;
      etiquetaContainer.style.display = 'block';
    }


    // 6. Adiciona o clique no botão (MODIFICADO)
    btnTestar.addEventListener('click', async () => {
      // MUDANÇA: Lê o código da venda
      const codigoVenda = inputCodigoVenda.value; 
      const de = inputDe.value;
      const ate = inputAte.value;

      // MUDANÇA: Validação
      if (!codigoVenda) {
        output.textContent = "Erro: O Código da Venda é obrigatório.";
        return;
      }

      output.textContent = "Invocando função... Aguarde...";
      etiquetaContainer.style.display = 'none'; // Esconde etiqueta antiga
      btnTestar.disabled = true;

      try {
        // 7. Invoca a função (MUDANÇA no body)
        const { data, error } = await supabase.functions.invoke('get-nota-details', {
          body: {
            codigoVenda: codigoVenda, // Envia codigoVenda
            de: de,
            ate: ate
          }
        });

        if (error) throw error; // Joga para o 'catch'

        // Sucesso! Mostra o JSON formatado
        output.textContent = JSON.stringify(data, null, 2);
        
        // NOVO: Mostra a etiqueta de teste
        mostrarEtiquetaTeste(data);

      } catch (err) {
        const errorMsg = err.context?.error?.message || err.message || JSON.stringify(err, null, 2);
        output.textContent = "ERRO AO INVOCAR:\n" + errorMsg;
      
      } finally {
        btnTestar.disabled = false;
      }
    });
  </script>

</body>
</html>