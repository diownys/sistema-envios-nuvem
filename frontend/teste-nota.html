<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Teste da Função (Nota Simplificada)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    input, button { font-size: 16px; padding: 8px; margin: 5px; }
    input[type="date"] { width: 150px; }
    #chave { width: 450px; }
    pre { background-color: #f4f4f4; border: 1px solid #ddd; padding: 10px; }
  </style>
</head>
<body>

  <h2>Teste da Função: get-nota-details</h2>
  
  <div>
    <label for="chave">Chave NFe (44 dígitos):</label><br>
    <input type="text" id="chave" placeholder="Cole a chave da NFe aqui...">
  </div>
  
  <div>
    <label for="de">De:</label><br>
    <input type="date" id="de">
  </div>
  
  <div>
    <label for="ate">Até:</label><br>
    <input type="date" id="ate">
  </div>
  
  <button id="btnTestar">Testar Função</button>

  <h3>Resultado:</h3>
  <pre id="resultado">(Aguardando teste...)</pre>

  <script>
    // 2. Configure com suas chaves do Supabase
    // (Você pode copiar isso do seu script.js principal)
    const SUPABASE_URL = 'https://nfsuisftzddegihyhoha.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mc3Vpc2Z0emRkZWdpaHlob2hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMTcwMDcsImV4cCI6MjA3NDU5MzAwN30.tM_9JQo6ejzOBWKQ9XxT54f8NuM6jSoHomF9c_IfEJI';
    
    // 3. Inicialize o cliente
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 4. Seleciona os elementos da página
    const btnTestar = document.getElementById('btnTestar');
    const inputChave = document.getElementById('chave');
    const inputDe = document.getElementById('de');
    const inputAte = document.getElementById('ate');
    const output = document.getElementById('resultado');

    // 5. Define datas padrão (últimos 30 dias)
    const hoje = new Date();
    const dataFim = hoje.toISOString().split('T')[0]; // "YYYY-MM-DD"
    hoje.setDate(hoje.getDate() - 30);
    const dataIni = hoje.toISOString().split('T')[0]; // "YYYY-MM-DD"
    
    inputDe.value = dataIni;
    inputAte.value = dataFim;

    // 6. Adiciona o clique no botão
    btnTestar.addEventListener('click', async () => {
      const chave = inputChave.value;
      const de = inputDe.value;
      const ate = inputAte.value;

      if (!chave || chave.length !== 44) {
        output.textContent = "Erro: A chave da NFe parece inválida (precisa ter 44 dígitos).";
        return;
      }

      output.textContent = "Invocando função... Aguarde...";
      btnTestar.disabled = true;

      try {
        // 7. Invoca a função que você fez deploy!
        const { data, error } = await supabase.functions.invoke('get-nota-details', {
          body: {
            chave: chave,
            de: de,
            ate: ate
          }
        });

        if (error) {
          throw error; // Joga para o 'catch'
        }

        // Sucesso! Mostra o JSON formatado
        output.textContent = JSON.stringify(data, null, 2);

      } catch (err) {
        // Erro! Mostra o erro
        output.textContent = "ERRO AO INVOCAR:\n" + JSON.stringify(err, null, 2);
      
      } finally {
        btnTestar.disabled = false;
      }
    });
  </script>

</body>
</html>