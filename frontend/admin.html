<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Administrador</title>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f9; margin: 0; padding: 1rem; }
        .container { max-width: 1200px; margin: auto; }
        .header { margin-bottom: 2rem; }
        .header a { color: #007bff; text-decoration: none; font-weight: bold; }
        h1, h2 { color: #333; }
        .controls-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
        /* Estilos adicionados do segundo HTML */
        .filters { display: flex; gap: 1rem; align-items: center; }
        #log-search-input, #date-filter-input { padding: 0.8rem; border-radius: 5px; border: 1px solid #ccc; font-size: 1rem; }
        #log-search-input { width: 300px; } /* Mantido do primeiro HTML */
        /* Fim dos estilos adicionados */
        .pagination-controls { display: flex; align-items: center; gap: 0.5rem; }
        .pagination-controls button { padding: 0.5rem 1rem; cursor: pointer; border-radius: 5px; border: 1px solid #ccc; }
        .pagination-controls button:disabled { cursor: not-allowed; opacity: 0.5; }
        .table-container { background: white; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); overflow-x: auto; margin-bottom: 2rem; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #ddd; }
        .form-container { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .input-group { margin-bottom: 1rem; }
        input, select, .form-container button { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .form-container button { background-color: #28a745; color: white; font-weight: bold; cursor: pointer; }
        .message { min-height: 1.2em; margin-top: 1rem; font-weight: bold; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        /* Zona de Perigo */
        .danger-zone {
            border: 2px solid #dc3545;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
            background-color: #f8d7da;
        }
        .danger-zone h2 {
            color: #721c24;
            margin-top: 0;
        }
        .danger-zone button {
            background-color: #dc3545;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/index.html">&larr; Voltar para o Menu Principal</a>
            <h1>Painel do Administrador</h1>
        </div>

        <h2>Logs de Atividade</h2>
        <div class="controls-container">
            <div class="filters">
                <input type="text" id="log-search-input" placeholder="Buscar nos logs...">
                <input type="date" id="date-filter-input"> </div>
            <div class="pagination-controls">
                <button id="prev-page-button">&larr; Anterior</button>
                <span id="page-info">Página 1 de 1</span>
                <button id="next-page-button">Próxima &rarr;</button>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th>Horário</th><th>Usuário</th><th>Ação</th><th>Cliente</th><th>Cód. Venda</th></tr></thead>
                <tbody id="logs-table-body"></tbody>
            </table>
        </div>

        <div class="danger-zone">
            <h2>Zona de Perigo</h2>
            <p>A ação abaixo é irreversível e irá apagar permanentemente todas as vendas do sistema.</p>
            <button id="delete-all-button">Excluir Todas as Vendas</button>
            <div id="delete-message" class="message" style="margin-top: 1rem;"></div>
        </div>
        
        <h2>Criar Novo Usuário</h2>
        <div class="form-container">
            <form id="create-user-form">
                <div class="input-group"><input type="email" id="new-email" placeholder="E-mail do novo usuário" required></div>
                <div class="input-group"><input type="password" id="new-password" placeholder="Senha temporária" required></div>
                <div class="input-group">
                    <select id="new-role" required>
                        <option value="user">Funcionário (User)</option>
                        <option value="admin">Administrador (Admin)</option>
                    </select>
                </div>
                <button type="submit">Criar Usuário</button>
            </form>
            <div id="form-message" class="message"></div>
        </div>
    </div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    // ⚠️ SUBSTITUA PELAS SUAS CHAVES REAIS AQUI (Mantido do primeiro HTML)
    const SUPABASE_URL = 'https://nfsuisftzddegihyhoha.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mc3Vpc2Z0emRkZWdpaHlob2hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMTcwMDcsImV4cCI6MjA3NDU5MzAwN30.tM_9JQo6ejzOBWKQ9XxT54f8NuM6jSoHomF9c_IfEJI'; 

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentPage = 1;
    let totalPages = 1;
    let currentSearchTerm = '';
    // Variáveis de data adicionadas do segundo HTML
    let currentStartDate, currentEndDate;
    const dateInput = document.getElementById('date-filter-input');

    // Função para logs (do primeiro HTML)
    function log(msg, type = '', element) {
        element.textContent = msg;
        element.className = `message ${type}`;
    }

    // Função para definir o filtro de data padrão para "hoje" (do segundo HTML)
    function setDefaultDateFilter() {
        const today = new Date();
        const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);

        currentStartDate = startOfDay.toISOString();
        currentEndDate = endOfDay.toISOString();

        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        dateInput.value = `${yyyy}-${mm}-${dd}`;
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) { window.location.href = '/login.html'; return; }
        
        const { data: isAdmin } = await supabase.rpc('is_admin');
        if (!isAdmin) {
            alert('Acesso negado. Esta área é apenas para administradores.');
            window.location.href = '/index.html';
            return;
        }
        
        setDefaultDateFilter(); // Define o filtro padrão para hoje
        setupEventListeners();
        
        // Lógica de exclusão de vendas (do primeiro HTML)
        const deleteButton = document.getElementById('delete-all-button');
        const deleteMessageDiv = document.getElementById('delete-message');

        deleteButton.addEventListener('click', async () => {
            const confirm1 = prompt("Esta ação é IRREVERSÍVEL e apagará TODAS as vendas. Para confirmar, digite 'excluir tudo':");
            if (confirm1 !== 'excluir tudo') {
                log('Exclusão cancelada.', 'error', deleteMessageDiv);
                return;
            }

            const confirm2 = prompt("Confirmação final. Tem ABSOLUTA CERTEZA? Digite 'sim, eu tenho certeza':");
            if (confirm2 !== 'sim, eu tenho certeza') {
                log('Exclusão cancelada.', 'error', deleteMessageDiv);
                return;
            }

            deleteButton.disabled = true;
            log('Excluindo todos os dados, aguarde...', '', deleteMessageDiv);

            try {
                const { data, error } = await supabase.functions.invoke('delete-all-envios');
                if (error) throw error;
                log(data.message, 'success', deleteMessageDiv);
                setTimeout(() => carregarLogs(1, ''), 2000);
            } catch (err) {
                log('Erro: ' + (err?.message ?? err), 'error', deleteMessageDiv);
            } finally {
                deleteButton.disabled = false;
            }
        });

        carregarLogs(currentPage, currentSearchTerm);
    });
    
    function setupEventListeners() {
        const searchInput = document.getElementById('log-search-input');
        const prevButton = document.getElementById('prev-page-button');
        const nextButton = document.getElementById('next-page-button');
        const createUserForm = document.getElementById('create-user-form');
        
        // Controles de Paginação (do primeiro HTML)
        prevButton.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                carregarLogs(currentPage, currentSearchTerm);
            }
        });
        nextButton.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                carregarLogs(currentPage, currentSearchTerm);
            }
        });

        // Campo de Busca (do primeiro HTML)
        let searchTimeout;
        searchInput.addEventListener('input', (event) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentSearchTerm = event.target.value;
                currentPage = 1;
                carregarLogs(currentPage, currentSearchTerm);
            }, 300);
        });

        // Formulário de Criação de Usuário (do primeiro HTML)
        createUserForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const messageDiv = document.getElementById('form-message');
            const email = document.getElementById('new-email').value;
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;
            messageDiv.textContent = 'Criando usuário...';
            messageDiv.className = 'message';
            const { data, error } = await supabase.functions.invoke('create-user', { body: { email, password, role } });
            if (error) {
                messageDiv.textContent = `Erro: ${error.message}`;
                messageDiv.className = 'message error';
            } else {
                messageDiv.textContent = data.message;
                messageDiv.className = 'message success';
                createUserForm.reset();
            }
        });

        // Filtro de Data (do segundo HTML)
        dateInput.addEventListener('change', () => {
            const selectedDate = new Date(dateInput.value + 'T00:00:00'); // Adiciona T00:00:00 para tratar fuso horário
            
            const startOfDay = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
            const endOfDay = new Date(startOfDay);
            endOfDay.setDate(endOfDay.getDate() + 1);

            currentStartDate = startOfDay.toISOString();
            currentEndDate = endOfDay.toISOString();
            currentPage = 1;
            carregarLogs(currentPage, currentSearchTerm);
        });
    }

    async function carregarLogs(page = 1, searchTerm = '') {
        const tableBody = document.getElementById('logs-table-body');
        const pageInfo = document.getElementById('page-info');
        const prevButton = document.getElementById('prev-page-button');
        const nextButton = document.getElementById('next-page-button');
        tableBody.innerHTML = `<tr><td colspan="5">Carregando...</td></tr>`;
        
        try {
            // Chamada de função do Supabase alterada para 'get_paginated_logs'
            // e passagem dos novos parâmetros de data (como no segundo HTML)
            const { data, error } = await supabase.rpc('get_paginated_logs', { 
                page_number: page, 
                search_term: searchTerm,
                start_date_param: currentStartDate,
                end_date_param: currentEndDate
            });

            if (error) throw error;
            
            // Lógica de contagem e paginação adaptada para a estrutura de resposta do get_paginated_logs
            const totalCount = data.length > 0 ? data[0].total_count : 0;
            totalPages = Math.ceil(totalCount / 10);
            if (totalPages === 0) totalPages = 1;
            
            renderTable(data);
            pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
            prevButton.disabled = currentPage <= 1;
            nextButton.disabled = currentPage >= totalPages;
        } catch (error) {
            tableBody.innerHTML = `<tr><td colspan="5">Erro ao carregar logs: ${error.message}</td></tr>`;
        }
    }
    
    function renderTable(logs) {
        const tableBody = document.getElementById('logs-table-body');
        tableBody.innerHTML = '';
        // Note que a estrutura do log é a mesma, mas se estiver usando a função RPC
        // 'get_paginated_logs', os campos devem vir diretamente da função.
        if (!logs || logs.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5">Nenhum log encontrado para o dia.</td></tr>`;
            return;
        }
        logs.forEach(log => {
            tableBody.innerHTML += `
                <tr>
                    <td>${new Date(log.created_at).toLocaleString('pt-BR')}</td>
                    <td>${log.user_email || 'N/A'}</td>
                    <td>${log.action}</td>
                    <td>${log.cliente_nome || 'N/A'}</td>
                    <td>${log.codigo_venda || 'N/A'}</td>
                </tr>
            `;
        });
    }
</script>
</body>
</html>