<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vendas Concluídas</title>
  <style>
    body { font-family: sans-serif; background-color: #f4f4f9; margin: 0; padding: 1rem; }
    .header { margin-bottom: 1rem; } .header a { color: #007bff; text-decoration: none; font-weight: bold; }
    h1 { color: #333; }
    .controls { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; align-items: center; }
    .controls .search-group { flex-grow: 1; min-width: 200px; }
    .controls .date-group { display: flex; gap: 0.5rem; align-items: center; }
    .controls input { padding: 0.8rem; border-radius: 5px; border: 1px solid #ccc; font-size: 1rem; }
    .table-container { background: white; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #ddd; }
    .actions-cell { display: flex; gap: 0.5rem; }
    .btn { padding: 0.5rem 1rem; text-decoration: none; border-radius: 5px; font-size: 0.9rem; border: none; cursor: pointer; color: white; }
    .btn-reprint { background-color: #17a2b8; }
    .btn-revert { background-color: #ffc107; color: #212529; }
  </style>
</head>
<body>
  <div class="header">
    <a href="/index.html">&larr; Voltar ao Menu</a>
    <h1>Vendas Concluídas</h1>
  </div>

  <div class="controls">
    <div class="search-group">
      <input type="text" id="search-input" placeholder="Busque por cliente ou cód. venda..." style="width: 100%;">
    </div>
    <div class="date-group">
      <label for="start-date-input">De:</label>
      <input type="date" id="start-date-input">
      <label for="end-date-input">Até:</label>
      <input type="date" id="end-date-input">
    </div>
  </div>

  <div class="table-container">
    <table>
      <thead><tr><th>Cliente</th><th>Cód. Venda</th><th>Volumes</th><th>Confirmado em</th><th>Ações</th></tr></thead>
      <tbody id="concluidos-table-body"></tbody>
    </table>
  </div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const SUPABASE_URL = 'https://nfsuisftzddegihyhoha.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mc3Vpc2Z0emRkZWdpaHlob2hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMTcwMDcsImV4cCI6MjA3NDU5MzAwN30.tM_9JQo6ejzOBWKQ9XxT54f8NuM6jSoHomF9c_IfEJI';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let concluidosData = [];
    const tableBody = document.getElementById('concluidos-table-body');
    const searchInput = document.getElementById('search-input');
    const startDateInput = document.getElementById('start-date-input');
    const endDateInput = document.getElementById('end-date-input');

    // NOVO: Função centralizada para aplicar todos os filtros
    function aplicarFiltros() {
        const query = searchInput.value.toLowerCase();
        
        // Pega as datas dos inputs e ajusta para o início e fim do dia
        const startDate = new Date(startDateInput.value);
        startDate.setHours(0, 0, 0, 0);

        const endDate = new Date(endDateInput.value);
        endDate.setHours(23, 59, 59, 999);

        const vendasFiltradas = concluidosData.filter(venda => {
            // Filtro de texto
            const textMatch = (venda.cliente_nome?.toLowerCase().includes(query)) ||
                              (venda.codigo_venda?.toLowerCase().includes(query));
            
            // Filtro de data
            const vendaDate = new Date(venda.updated_at);
            const dateMatch = vendaDate >= startDate && vendaDate <= endDate;

            return textMatch && dateMatch; // Retorna verdadeiro apenas se ambos os filtros corresponderem
        });

        renderTable(vendasFiltradas);
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) { window.location.href = '/login.html'; return; }
        
        // NOVO: Define a data de hoje nos campos de data ao carregar a página
        const hoje = new Date().toISOString().split('T')[0]; // Formato YYYY-MM-DD
        startDateInput.value = hoje;
        endDateInput.value = hoje;
        
        await carregarConcluidos();
        
        // ATUALIZADO: Event listeners agora chamam a função central de filtro
        searchInput.addEventListener('input', aplicarFiltros);
        startDateInput.addEventListener('change', aplicarFiltros);
        endDateInput.addEventListener('change', aplicarFiltros);
    });
    
    function renderTable(dadosParaRenderizar) {
        tableBody.innerHTML = '';
        if (dadosParaRenderizar.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5">Nenhuma venda encontrada para o filtro atual.</td></tr>';
            return;
        }
        dadosParaRenderizar.forEach(venda => {
            tableBody.innerHTML += `
                <tr>
                    <td>${venda.cliente_nome || 'N/A'}</td>
                    <td>${venda.codigo_venda || 'N/A'}</td>
                    <td>${venda.volumes || '1'}</td>
                    <td>${new Date(venda.updated_at).toLocaleString('pt-BR')}</td>
                    <td class="actions-cell">
                        <button class="btn btn-revert" data-venda-id="${venda.id}">Reverter</button>
                        <button class="btn btn-reprint" data-venda-id="${venda.id}">Reimprimir</button>
                    </td>
                </tr>
            `;
        });
    }

    async function carregarConcluidos() {
        tableBody.innerHTML = '<tr><td colspan="5">Carregando...</td></tr>';
        try {
            const { data, error } = await supabase.functions.invoke('get-concluidos');
            if (error) throw error;
            concluidosData = data.concluidos;
            aplicarFiltros(); // ATUALIZADO: Aplica o filtro (de hoje) assim que os dados carregam
        } catch (error) {
            tableBody.innerHTML = `<tr><td colspan="5">Erro ao carregar vendas: ${error.message}</td></tr>`;
        }
    }

    tableBody.addEventListener('click', async (event) => {
        const target = event.target;
        const vendaId = target.dataset.vendaId;

        if (target.matches('.btn-revert')) {
            if (confirm('Tem certeza que deseja reverter esta venda para "Pendente"?')) {
                target.textContent = 'Revertendo...';
                const { error } = await supabase.functions.invoke('reverter-envio', { body: { envio_id: parseInt(vendaId) } });
                if (error) {
                    alert(`Erro ao reverter: ${error.message}`);
                    target.textContent = 'Reverter';
                } else {
                    // ATUALIZADO: Remove da lista principal e aplica os filtros novamente
                    concluidosData = concluidosData.filter(v => v.id != vendaId);
                    aplicarFiltros(); 
                }
            }
        }

        if (target.matches('.btn-reprint')) {
            target.textContent = 'Gerando...';
            try {
                const { data: htmlString, error } = await supabase.functions.invoke('gerar-etiqueta', { body: { envio_id: parseInt(vendaId) }, responseType: 'text' });
                if (error) throw error;
                const printWindow = window.open('', '_blank');
                printWindow.document.write(htmlString);
                printWindow.document.close();
                printWindow.print();
            } catch (error) {
                alert(`Erro ao reimprimir: ${error.message}`);
            } finally {
                target.textContent = 'Reimprimir';
            }
        }
    });
</script>
</body>
</html>