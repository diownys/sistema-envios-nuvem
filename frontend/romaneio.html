<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Gerar Romaneio</title>

  <!-- PREENCHA com os valores do seu projeto Supabase -->
  <meta name="supabase-url"  content="https://nfsuisftzddegihyhoha.supabase.co">
  <meta name="supabase-anon" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mc3Vpc2Z0emRkZWdpaHlob2hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMTcwMDcsImV4cCI6MjA3NDU5MzAwN30.tM_9JQo6ejzOBWKQ9XxT54f8NuM6jSoHomF9c_IfEJI">

  <style>
    body { font-family: sans-serif; margin: 24px; background:#f7f7fb; }
    .card { background:#fff; border:1px solid #e9e9ef; border-radius:8px; padding:16px; max-width:720px; }
    .row { display:flex; gap:12px; align-items:center; margin:12px 0; flex-wrap:wrap; }
    label { min-width:110px; color:#333; }
    input, select, button { padding:8px 10px; border:1px solid #d0d0da; border-radius:6px; }
    button { background:#007bff; color:#fff; cursor:pointer; }
    button:disabled { background:#c7c7d3; cursor:not-allowed; }
    #log { white-space:pre-wrap; background:#fafafa; border:1px dashed #ddd; padding:10px; border-radius:6px; margin-top:10px; min-height:3em; }
    a { color:#6c757d; text-decoration:none; }
  </style>
</head>
<body>
  <h1>Gerar Romaneio de Coleta</h1>
  <div class="card">
    <div class="row">
      <label for="start">Início</label>
      <input id="start" type="date"/>
      <label for="end">Fim</label>
      <input id="end" type="date"/>
      <button id="btnCarregar">Carregar janelas</button>
    </div>

    <div class="row">
      <label for="janelas">Janelas</label>
      <select id="janelas" style="min-width:280px">
        <option>-- carregue o período --</option>
      </select>
      <button id="btnGerar" disabled>Gerar Documento</button>
    </div>

    <div id="log">Aguardando…</div>

    <div class="row">
      <a href="/index.htm">Voltar ao Dashboard</a>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const logDiv = document.getElementById('log')
    const log = (m) => { logDiv.textContent = m }

    function getMeta(name) {
      const el = document.querySelector(`meta[name="${name}"]`)
      return el?.content?.trim() || ''
    }

    const SUPABASE_URL  = getMeta('supabase-url')
    const SUPABASE_ANON = getMeta('supabase-anon')

    if (!SUPABASE_URL || !SUPABASE_ANON) {
      log("Configuração ausente: adicione <meta name=\"supabase-url\"> e <meta name=\"supabase-anon\"> no <head> com os valores do seu projeto.")
      throw new Error('Metas supabase-url/supabase-anon ausentes.')
    }

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON)

    // Monta domínio das Functions com fallback
    let FUNCTIONS_URL = ''
    try {
      const projectRef = new URL(SUPABASE_URL).hostname.split('.')[0]
      FUNCTIONS_URL = `https://${projectRef}.functions.supabase.co/get-janelas-para-romaneio`
    } catch (e) {
      FUNCTIONS_URL = '/functions/v1/get-janelas-para-romaneio' // fallback
    }

    const start = document.getElementById('start')
    const end   = document.getElementById('end')
    const btnCarregar = document.getElementById('btnCarregar')
    const selJanelas  = document.getElementById('janelas')
    const btnGerar    = document.getElementById('btnGerar')

    // defaults: hoje (YYYY-MM-DD)
    const today = new Date()
    const y = today.getFullYear()
    const m = String(today.getMonth()+1).padStart(2,'0')
    const d = String(today.getDate()).padStart(2,'0')
    start.value = `${y}-${m}-${d}`
    end.value   = `${y}-${m}-${d}`

    btnCarregar.addEventListener('click', async () => {
      try {
        btnCarregar.disabled = true
        btnGerar.disabled = true
        selJanelas.innerHTML = '<option>Carregando…</option>'
        log('Consultando janelas confirmadas…')

        const { data: { session } } = await supabase.auth.getSession()
        if (!session?.access_token) {
          log('Sessão expirada. Faça login novamente.')
          location.href = '/login.html'
          return
        }

        const qs = new URLSearchParams({ start_date: start.value, end_date: end.value }).toString()
        const resp = await fetch(`${FUNCTIONS_URL}?${qs}`, {
          headers: { Authorization: `Bearer ${session.access_token}` }
        })

        let payload
        try { payload = await resp.json() } catch { payload = { error: 'Resposta inválida da função.' } }
        if (!resp.ok) throw new Error(payload?.error || 'Falha ao buscar janelas.')

        const { janelas = [], range } = payload
        log(`Período: ${range?.startISO ?? '?'} → ${range?.endISO ?? '?'}\nEncontradas ${janelas.length} janelas.`)

        selJanelas.innerHTML = ''
        if (janelas.length === 0) {
          selJanelas.innerHTML = '<option>Sem janelas para o período.</option>'
          btnGerar.disabled = true
          return
        }
        for (const j of janelas) {
          const opt = document.createElement('option')
          opt.value = j
          opt.textContent = j
          selJanelas.appendChild(opt)
        }
        btnGerar.disabled = false
      } catch (e) {
        log('Erro: ' + (e?.message ?? e))
        selJanelas.innerHTML = '<option>Erro ao carregar.</option>'
      } finally {
        btnCarregar.disabled = false
      }
    })

    btnGerar.addEventListener('click', () => {
      const janela = selJanelas.value
      if (!janela || janela.startsWith('Sem ') || janela.startsWith('--')) {
        log('Selecione uma janela válida.')
        return
      }
      log(`Romaneio para: ${janela} (implementar geração do documento)`) 
    })
  </script>
</body>
</html>