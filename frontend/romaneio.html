<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Gerar Romaneio</title>

  <!-- Credenciais públicas -->
  <meta name="supabase-url"  content="SUA_SUPABASE_URL">
  <meta name="supabase-anon" content="SUA_SUPABASE_ANON_KEY">

  <style>
    body { font-family: sans-serif; margin: 24px; background:#f7f7fb; }
    .card { background:#fff; border:1px solid #e9e9ef; border-radius:8px; padding:16px; max-width:720px; }
    .row { display:flex; gap:12px; align-items:center; margin:12px 0; flex-wrap:wrap; }
    label { min-width:110px; color:#333; }
    input, select, button { padding:8px 10px; border:1px solid #d0d0da; border-radius:6px; }
    button { background:#007bff; color:#fff; cursor:pointer; }
    button:disabled { background:#c7c7d3; cursor:not-allowed; }
    #log { white-space:pre-wrap; background:#fafafa; border:1px dashed #ddd; padding:10px; border-radius:6px; margin-top:10px; }
    a { color:#6c757d; text-decoration:none; }
  </style>
</head>
<body>
  <h1>Gerar Romaneio de Coleta</h1>
  <div class="card">
    <div class="row">
      <label for="start">Início</label>
      <input id="start" type="date"/>
      <label for="end">Fim</label>
      <input id="end" type="date"/>
      <button id="btnCarregar">Carregar janelas</button>
    </div>

    <div class="row">
      <label for="janelas">Janelas</label>
      <select id="janelas" style="min-width:280px">
        <option>-- carregue o período --</option>
      </select>
      <button id="btnGerar" disabled>Gerar Documento</button>
    </div>

    <div id="log">Aguardando…</div>

    <div class="row">
      <a href="/index.htm">Voltar ao Dashboard</a>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const SUPABASE_URL  = document.querySelector('meta[name="https://nfsuisftzddegihyhoha.supabase.co"]').content
    const SUPABASE_ANON = document.querySelector('meta[name="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mc3Vpc2Z0emRkZWdpaHlob2hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMTcwMDcsImV4cCI6MjA3NDU5MzAwN30.tM_9JQo6ejzOBWKQ9XxT54f8NuM6jSoHomF9c_IfEJI"]').content
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON)

    // Domínio das Functions
    const projectRef = new URL(SUPABASE_URL).hostname.split('.')[0]
    const FN_URL = `https://${projectRef}.functions.supabase.co/get-janelas-para-romaneio`

    const start = document.getElementById('start')
    const end   = document.getElementById('end')
    const btnCarregar = document.getElementById('btnCarregar')
    const selJanelas  = document.getElementById('janelas')
    const btnGerar    = document.getElementById('btnGerar')
    const log = (m) => document.getElementById('log').textContent = m

    // defaults: hoje
    const today = new Date()
    const y = today.getFullYear()
    const m = String(today.getMonth()+1).padStart(2,'0')
    const d = String(today.getDate()).padStart(2,'0')
    start.value = `${y}-${m}-${d}`
    end.value   = `${y}-${m}-${d}`

    btnCarregar.addEventListener('click', async () => {
      try {
        btnCarregar.disabled = true
        btnGerar.disabled = true
        selJanelas.innerHTML = '<option>Carregando…</option>'
        log('Consultando janelas confirmadas…')

        const { data: { session } } = await supabase.auth.getSession()
        if (!session?.access_token) {
          log('Sessão expirada. Faça login novamente.')
          location.href = '/login.html'
          return
        }

        const qs = new URLSearchParams({
          start_date: start.value,
          end_date:   end.value
        }).toString()

        const resp = await fetch(`${FN_URL}?${qs}`, {
          headers: { Authorization: `Bearer ${session.access_token}` }
        })
        const payload = await resp.json()
        if (!resp.ok) throw new Error(payload?.error || 'Falha ao buscar janelas.')

        const { janelas, range } = payload
        log(`Período: ${range.startISO} → ${range.endISO}\nEncontradas ${janelas.length} janelas.`)

        selJanelas.innerHTML = ''
        if (janelas.length === 0) {
          selJanelas.innerHTML = '<option>Sem janelas para o período.</option>'
          btnGerar.disabled = true
          return
        }
        for (const j of janelas) {
          const opt = document.createElement('option')
          opt.value = j
          opt.textContent = j
          selJanelas.appendChild(opt)
        }
        btnGerar.disabled = false
      } catch (e) {
        log('Erro: ' + (e?.message ?? e))
        selJanelas.innerHTML = '<option>Erro ao carregar.</option>'
      } finally {
        btnCarregar.disabled = false
      }
    })

    btnGerar.addEventListener('click', () => {
      const janela = selJanelas.value
      if (!janela || janela.startsWith('Sem ') || janela.startsWith('--')) {
        log('Selecione uma janela válida.')
        return
      }
      // TODO: integrar a geração de romaneio desta janela
      log(`Romaneio para: ${janela} (implementar geração do documento)`) 
    })
  </script>
</body>
</html>
