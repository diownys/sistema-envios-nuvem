<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importar Envios</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f4f4f9; margin: 0; }
        .container { background: white; padding: 2rem 3rem; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: center; }
        h1 { color: #333; }
        input[type="file"] { border: 1px solid #ddd; padding: 0.5rem; border-radius: 4px; width: 100%; }
        button { background-color: #007bff; color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 4px; cursor: pointer; font-size: 1rem; margin-top: 1rem; }
        button:disabled { background-color: #ccc; }
        a { display: block; margin-top: 1rem; color: #6c757d; }
        .message { min-height: 1.2em; margin-top: 1rem; font-weight: bold; }
        .success { color: #28a745; } .error { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Importar Planilha (.csv)</h1>
        <form id="upload-form">
            <input type="file" id="csv-file" accept=".csv" required>
            <button type="submit">Enviar Arquivo</button>
        </form>
        <div id="status-message" class="message"></div>
        <a href="/index.html">Voltar ao Dashboard</a>
    </div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const SUPABASE_URL = 'https://nfsuisftzddegihyhoha.supabase.co'; // Encontrada em Project Settings > API
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mc3Vpc2Z0emRkZWdpaHlob2hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMTcwMDcsImV4cCI6MjA3NDU5MzAwN30.tM_9JQo6ejzOBWKQ9XxT54f8NuM6jSoHomF9c_IfEJI'; // A chave pública (anon)

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    document.addEventListener('DOMContentLoaded', async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) { window.location.href = '/login.html'; return; }
    });

    const form = document.getElementById('upload-form');
    const fileInput = document.getElementById('csv-file');
    const messageDiv = document.getElementById('status-message');
    const submitButton = form.querySelector('button');

    form.addEventListener('submit', (event) => {
        event.preventDefault();
        const file = fileInput.files[0];
        if (!file) { /* ... (código de erro) ... */ return; }
        
        submitButton.disabled = true;
        submitButton.textContent = 'Processando...';
        messageDiv.textContent = 'Lendo arquivo localmente...';

        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            delimiter: ";",
            complete: async (results) => {
                const dadosMapeados = results.data.map((linha) => {
                    const valorLimpo = String(linha['Valor da Venda'] || '0').replace(/[^0-9,]/g, '').replace(',', '.');
                    const valorNumerico = parseFloat(valorLimpo);
                    return {
                        codigo_venda: linha['Código da Venda'],
                        cliente_nome: linha['Cliente'],
                        valor_venda: isNaN(valorNumerico) ? 0 : valorNumerico,
                        local_entrega: linha['Local de entrega'],
                        forma_farmaceutica: linha['Forma Farmacêutica'],
                        cidade: linha['Cidade'],
                        uf: linha['uf'],
                        requer_refrigeracao: String(linha['Tem produto refrigerado'] || '').toLowerCase() === 'sim',
                        ordem_manipulacao: linha['Ordem de manipulação QRCODE'],
                        janela_coleta: linha['Janela de Coleta'],
                        volumes: parseInt(linha['Volumes'], 10) || 1,
                        endereco: linha['endereco'],
                        numero_nota: linha['numero_nota'],
                        status: 'Pendente'
                    };
                }).filter(v => v.codigo_venda);

                if (dadosMapeados.length === 0) {
                    messageDiv.textContent = 'Erro: Nenhuma linha válida encontrada no CSV.';
                    messageDiv.className = 'message error';
                    submitButton.disabled = false;
                    submitButton.textContent = 'Enviar Arquivo';
                    return;
                }

                messageDiv.textContent = `Enviando ${dadosMapeados.length} registros...`;
                try {
                    const { data, error } = await supabase.functions.invoke('import-excel', {
                        body: dadosMapeados
                    });
                    if (error) throw error;
                    messageDiv.textContent = data.message;
                    messageDiv.className = 'message success';
                    form.reset();
                } catch (error) {
                    messageDiv.textContent = `Erro: ${error.message}`;
                    messageDiv.className = 'message error';
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Enviar Arquivo';
                }
            },
            error: (err) => { /* ... (código de erro) ... */ }
        });
    });
</script>
</body>
</html>