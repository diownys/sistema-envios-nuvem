<!-- importar.html -->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Importar Envios</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; max-width: 640px; }
    .row { margin: 12px 0; }
    #log { white-space: pre-wrap; background: #f7f7f7; padding: 12px; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>Importar Envios</h1>
  <div class="card">
    <div class="row">
      <label for="file">Selecione a planilha (.xlsx ou .csv)</label><br/>
      <input id="file" type="file" accept=".xlsx,.xls,.csv" />
    </div>
    <div class="row">
      <button id="btnEnviar">Enviar</button>
      <index.htmlVoltar ao Dashboard</a>
    </div>
    <div class="row"><div id="log"></div></div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    // TODO: substitua pelas suas variáveis reais (públicas)
    const SUPABASE_URL = 'https://nfsuisftzddegihyhoha.supabase.co'; // Encontrada em Project Settings > API
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mc3Vpc2Z0emRkZWdpaHlob2hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMTcwMDcsImV4cCI6MjA3NDU5MzAwN30.tM_9JQo6ejzOBWKQ9XxT54f8NuM6jSoHomF9c_IfEJI'; // A chave pública (anon)

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON)

    const log = (msg) => document.getElementById('log').textContent = msg

    document.getElementById('btnEnviar').addEventListener('click', async () => {
      try {
        const fileInput = document.getElementById('file')
        const file = fileInput.files?.[0]
        if (!file) return log('Selecione um arquivo .xlsx ou .csv')

        // exige usuário autenticado (a função valida o user do token)
        const { data: { session } } = await supabase.auth.getSession()
        if (!session?.access_token) {
          log('Sessão expirada. Faça login novamente.')
          location.href = '/login.html'
          return
        }

        log('Enviando arquivo… aguarde.')
        const form = new FormData()
        form.append('file', file, file.name)

        const resp = await fetch('/functions/v1/import-excel', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${session.access_token}` },
          body: form
        })

        const json = await resp.json()
        if (!resp.ok) throw new Error(json?.error || 'Falha ao importar.')
        log(json.message || 'Importação concluída!')
      } catch (err) {
        log('Erro: ' + (err?.message ?? err))
      }
    })
  </script>
</body>
</html>