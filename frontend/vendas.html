<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vendas da Janela</title>
  <style>
    body { font-family: sans-serif; background-color: #f4f4f9; margin: 0; padding: 1rem; }
    .header { margin-bottom: 2rem; } .header a { color: #007bff; text-decoration: none; font-weight: bold; }
    h1 { color: #333; }
    .table-container { background: white; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #f8f9fa; }
    .actions-cell { display: flex; gap: 0.5rem; }
    .btn { padding: 0.5rem 1rem; text-decoration: none; border-radius: 5px; font-size: 0.9rem; border: none; cursor: pointer; color: white; }
    .btn-edit { background-color: #ffc107; color: #212529; } /* NOVO ESTILO */
    .btn-confirm { background-color: #007bff; }
    .btn-confirmed { background-color: #28a745; cursor: not-allowed; }
    /* Estilos do Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 400px; }
    .modal-content h2 { margin-top: 0; }
    .modal-content label { display: block; margin-top: 1rem; font-weight: bold; }
    .modal-content input { width: 100%; padding: 0.8rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-top: 0.5rem; }
    .modal-footer { margin-top: 1.5rem; text-align: right; display: flex; gap: 0.5rem; justify-content: flex-end; }
  </style>
</head>
<body>
  <div class="header">
    <a href="/index.html">&larr; Voltar para o Menu</a>
    <h1 id="titulo-janela">Carregando...</h1>
  </div>
  <div class="table-container">
    <table>
      <thead><tr><th>Cliente</th><th>Valor</th><th>Volumes</th><th>Status</th><th>Ações</th></tr></thead>
      <tbody id="vendas-table-body"></tbody>
    </table>
  </div>

  <div id="confirm-modal" class="modal-overlay">
    <div class="modal-content">
      <h2 id="modal-title">Confirmar Venda</h2>
      <p><strong>Cliente:</strong> <span id="modal-cliente-nome"></span></p>
      <form id="confirm-form">
        <label for="volumes-input">Quantidade de Volumes:</label>
        <input type="number" id="volumes-input" min="1" required>
        <input type="hidden" id="envio-id-input">
        <div class="modal-footer">
          <button type="button" id="cancel-button" class="btn" style="background-color: #6c757d;">Cancelar</button>
          <button type="submit" id="save-button" class="btn" style="background-color: #28a745;">Salvar Confirmação</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const SUPABASE_URL = 'https://nfsuisftzddegihyhoha.supabase.co'; // Encontrada em Project Settings > API
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mc3Vpc2Z0emRkZWdpaHlob2hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMTcwMDcsImV4cCI6MjA3NDU5MzAwN30.tM_9JQo6ejzOBWKQ9XxT54f8NuM6jSoHomF9c_IfEJI'; // A chave pública (anon)

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let vendasData = [];

    document.addEventListener('DOMContentLoaded', async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { window.location.href = '/login.html'; return; }
      const params = new URLSearchParams(window.location.search);
      const janelaColeta = params.get('janela');
      if (!janelaColeta) { document.getElementById('titulo-janela').textContent = "Erro: Janela não especificada."; return; }
      document.getElementById('titulo-janela').textContent = `Vendas da Janela: ${janelaColeta}`;
      await carregarVendas(janelaColeta);
    });

    function renderTable() {
      const tableBody = document.getElementById('vendas-table-body');
      tableBody.innerHTML = '';
      if (vendasData.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5">Nenhuma venda encontrada para esta janela.</td></tr>';
        return;
      }
      vendasData.forEach(venda => {
        tableBody.innerHTML += `
          <tr id="venda-row-${venda.id}">
            <td>${venda.cliente_nome || 'N/A'}</td>
            <td>R$ ${venda.valor_venda || '0,00'}</td>
            <td>${venda.volumes || '1'}</td>
            <td>${venda.status || 'Pendente'}</td>
            <td class="actions-cell">
              <a href="#" class="btn btn-edit" data-venda-id="${venda.id}">Editar</a>
              ${venda.status !== 'Confirmado' ? 
                `<button class="btn btn-confirm" data-venda-id="${venda.id}">Confirmar</button>` : 
                `<button class="btn btn-confirmed" disabled>Confirmado</button>`
              }
            </td>
          </tr>
        `;
      });
    }

    async function carregarVendas(janela) {
      try {
        const { data, error } = await supabase.functions.invoke('get-vendas-por-janela', { body: { janela: janela } });
        if (error) throw error;
        vendasData = data.vendas;
        renderTable();
      } catch (error) {
        document.getElementById('vendas-table-body').innerHTML = `<tr><td colspan="5">Erro ao carregar vendas: ${error.message}</td></tr>`;
      }
    }

    const modal = document.getElementById('confirm-modal');
    const confirmForm = document.getElementById('confirm-form');
    
    document.getElementById('vendas-table-body').addEventListener('click', async (event) => {
      const target = event.target;

      if (target.matches('.btn-confirm')) {
        const vendaId = target.dataset.vendaId;
        const venda = vendasData.find(v => v.id == vendaId);
        if (venda) {
          document.getElementById('modal-cliente-nome').textContent = venda.cliente_nome;
          document.getElementById('volumes-input').value = venda.volumes || 1;
          document.getElementById('envio-id-input').value = venda.id;
          modal.style.display = 'flex';
        }
      }

      // LÓGICA DO BOTÃO EDITAR (PLACEHOLDER)
      if (target.matches('.btn-edit')) {
          event.preventDefault();
          const vendaId = target.dataset.vendaId;
          // Por enquanto, podemos adicionar um link para a etiqueta ou um alerta
          alert('A funcionalidade de Editar será implementada em breve! Por enquanto, vamos gerar a etiqueta.');

          // Re-adicionando a lógica da etiqueta aqui
          target.textContent = 'Gerando...';
          try {
            const { data: htmlString, error } = await supabase.functions.invoke('gerar-eta', { body: { envio_id: parseInt(vendaId) }, responseType: 'text' });
            if (error) throw error;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(htmlString);
            printWindow.document.close();
            printWindow.print();
            target.textContent = 'Editar';
          } catch (error) {
            alert(`Erro ao gerar etiqueta: ${error.message}`);
            target.textContent = 'Editar';
          }
      }
    });

    confirmForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const vendaId = document.getElementById('envio-id-input').value;
        const volumes = document.getElementById('volumes-input').value;
        const saveButton = document.getElementById('save-button');
        saveButton.textContent = 'Salvando...';
        
        try {
            const { data, error } = await supabase.functions.invoke('confirmar-envio', { body: { envio_id: parseInt(vendaId), volumes: parseInt(volumes) } });
            if (error) throw error;

            const index = vendasData.findIndex(v => v.id == vendaId);
            if (index !== -1) {
              vendasData[index] = data.venda;
            }
            renderTable();
            modal.style.display = 'none';

        } catch(error) {
            alert(`Erro ao confirmar: ${error.message}`);
        } finally {
            saveButton.textContent = 'Salvar Confirmação';
        }
    });

    document.getElementById('cancel-button').addEventListener('click', () => {
        modal.style.display = 'none';
    });
  </script>
</body>
</html>